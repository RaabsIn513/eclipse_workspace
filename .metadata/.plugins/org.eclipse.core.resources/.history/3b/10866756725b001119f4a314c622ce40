package senior.project;

import java.util.Map;

import android.app.Activity;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.view.View;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

public class Settings_Activity extends Activity{
	
	private static String SAS_Settings = "SAS_SettingsFile";
	private static SharedPreferences SettingsFile;
	private static ArrayAdapter ad;
	private static ListView settingList;
	
	public void onCreate(Bundle savedInstanceState){
	    super.onCreate(savedInstanceState);
	    setContentView(R.layout.main_settings);
				
	    settingList = (ListView) findViewById(R.id.listSAS_settings);
	    loadSettingsFile();
	    
	    // When user selects list item
	    settingList.setOnItemClickListener(new OnItemClickListener(){
	    	public void onItemClick(AdapterView<?> parent, View view, int position, long id)
	    	{
	    		// Start integer chooser activity
	    	    Toast.makeText(getApplicationContext(), ((TextView) view).getText(),
	    	              Toast.LENGTH_SHORT).show();    
	    	    
	    	    if(((TextView) view).getText() == "SAMPLE_RATE" )
	    	    {
	    	    	// SAMPLE_RATE will use a list of sample rate options
	    	    	Intent intent = new Intent(view.getContext(), Integer_Chooser_Activity.class);
	    	    	intent.putExtra("INTLISTSIZE", 5);
	    	    	intent.putExtra("ORIGINAL", 8000);
	    	    	intent.putExtra("MIN_VALUE", 8000);
	    	    	intent.putExtra("MAX_VALUE",44100);
	    	    	
	    	    	startActivityForResult(intent, position);
	    	    }
	    	    if(((TextView) view).getText() == "SAMPLE_RATE" )
	    	    {
	    	    	Intent intent = new Intent();
	    	    	intent.putExtra("SAMP_HISTORY_SIZE", 8000);
	    	    	
	    	    	startActivityForResult(intent, position);
	    	    }
	    	}
	    });
	}
	
	public boolean loadSettingsFile()
	{
		SettingsFile = getSharedPreferences(SAS_Settings, 0);
		// cast table with key & value as strings
		try{
		Map<String,?> settingTable =  SettingsFile.getAll();
		Object[] okeys = settingTable.keySet().toArray();
		Object[] ovals = settingTable.values().toArray();
		String[] keys = new String[okeys.length];
		String[] vals = new String[ovals.length];
		
		keys = Obj_to_Str(okeys);
		vals = Obj_to_Str(ovals);
		
		String[] dispSets = new String[vals.length];
		
		for( int i = 0; i < dispSets.length; i++ )
			dispSets[i] = keys[i] + " - " + vals[i];			

		// If there are no setting values (ie first time ran) provide the 
		// default settings and values.
		if( vals.length == 0)
		{
			int numSettings = 3;
			dispSets = new String[numSettings];
			vals = new String[numSettings];
			keys = new String[numSettings];
			SharedPreferences.Editor edSet = SettingsFile.edit();
			
			edSet.putString("SAMPLE_RATE", "8000");
			edSet.putString("SAMP_HISTORY_SIZE", "64");
			edSet.putString("AMP_HIST_SIZE", "32");
			edSet.putString("THRESH_DIFF", "50");		// (current_max_amp) - (avg_max_amp)
			edSet.putString("THRESH_SAMPS", "16");		// The number of consecutive samples where 
														// (current_max_amp) - (avg_max_amp) > THRESH_DIFF 
														// before causing an event trigger
			edSet.commit();
		}
					
		ad = new ArrayAdapter<Object>(this, 
				android.R.layout.simple_expandable_list_item_1, dispSets);
		settingList.setAdapter(ad);
		
		}catch(Exception ex)
		{
			Toast.makeText(getBaseContext(), ex.getMessage(), 1500).show();
		}
		
		return true;
	}
	
    private String[] Obj_to_Str(Object[] ary)
    {
    	String[] result = new String[ary.length];
    	for( int i = 0; i < ary.length; i++)
    	{
    		try{
    			result[i] = ary[i].toString();
    		}
    		catch( Exception ex)
    		{
    			Toast.makeText(this, ex.getMessage(), 300);
    		}
    	}
    	return result;
    }
}
